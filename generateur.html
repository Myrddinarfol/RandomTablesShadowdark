<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB1DML2F9AJVVA1L0CNN1Se97TmLvJB0v8",
        authDomain: "randomtablesgenerator.firebaseapp.com",
        projectId: "randomtablesgenerator",
        storageBucket: "randomtablesgenerator.appspot.com",
        messagingSenderId: "144151661238",
        appId: "1:144151661238:web:3f973e0913122dba367417"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const familySelect = document.getElementById('family-select');
    const subfamilySelect = document.getElementById('subfamily-select');

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    familySelect.addEventListener('change', async function() {
        const selectedFamily = familySelect.value;
        console.log("Famille sélectionnée:", selectedFamily); // Log de la famille sélectionnée
        subfamilySelect.innerHTML = '';

        const docRef = doc(db, "Tables_aléatoires", selectedFamily);
        const docSnap = await getDoc(docRef);
        
        console.log("Document Snap:", docSnap); // Log du document récupéré

        if (docSnap.exists()) {
            const data = docSnap.data();
            console.log("Données récupérées:", data); // Log des données récupérées
            const subfamilies = Object.keys(data);

            subfamilies.forEach(subfamily => {
                const option = document.createElement('option');
                option.value = subfamily;
                option.textContent = capitalizeFirstLetter(subfamily);
                subfamilySelect.appendChild(option);
            });

            subfamilySelect.disabled = false;
        } else {
            console.log("Le document n'existe pas."); // Log si le document n'existe pas
            subfamilySelect.disabled = true;
        }
    });

    document.getElementById('generate-btn').addEventListener('click', async function () {
        const selectedFamily = familySelect.value;
        const selectedSubfamily = subfamilySelect.value;
        console.log("Famille sélectionnée pour génération:", selectedFamily);
        console.log("Sous-famille sélectionnée:", selectedSubfamily);
        
        const docRef = doc(db, "Tables_aléatoires", selectedFamily);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            const selectedTable = data[selectedSubfamily];

            if (selectedTable) {
                const randomIndex = Math.floor(Math.random() * selectedTable.length);
                const randomEvent = selectedTable[randomIndex];
                document.getElementById('result').innerHTML = `<p style="font-weight: bold;">${randomEvent}</p>`;
            } else {
                document.getElementById('result').innerHTML = `<p>Aucune table sélectionnée.</p>`;
            }
        }
    });

    subfamilySelect.disabled = true;
</script>
